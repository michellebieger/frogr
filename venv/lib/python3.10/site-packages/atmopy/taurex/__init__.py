from taurex.chemistry import AutoChemistry
from atmopy.io import baseline_molecules
from atmopy.runner import ATMORunner
from astropy import units as u
from taurex.cache import GlobalCache
from taurex.core import fitparam
import typing as t
import numpy as np

class ATMOChemistry(AutoChemistry):
    def __init__(
        self, metallicity = 0.0, cond_h2o = False
    ):
        super().__init__("ATMO")
        self.atmorunner = ATMORunner(
            atmo_path=GlobalCache()["atmo_path"],
            atmo_executable=GlobalCache()["atmo_executable"],
        )
        self.atmorunner.chemistry.metallicity = metallicity
        self.atmorunner.chemistry.condensation_h2o = cond_h2o

        self.mix = None

        self.element_ratios = []

        self.determine_active_inactive()


    @property
    def gases(self):
        return baseline_molecules()

    def initialize_chemistry(
        self,
        nlayers=100,
        temperature_profile=None,
        pressure_profile=None,
        altitude_profile=None,
    ):
        temperature = temperature_profile << u.K
        pressure = pressure_profile << u.Pa
        result = self.atmorunner.run(temperature, pressure)

        self.mix = result["abundances_vmr"]
        super().compute_mu_profile(nlayers=nlayers)

    @property
    def mixProfile(self):
        return self.mix

    @fitparam(param_name="metallicity", param_latex=r"$Z_{o}$")
    def metallicity(self):
        """"""
        return self.atmorunner.chemistry.metallicity

    @metallicity.setter
    def metallicity(self, value):
        self.atmorunner.chemistry.metallicity = value

    @classmethod
    def input_keywords(cls):
        return ["ATMO", "atmo"]
